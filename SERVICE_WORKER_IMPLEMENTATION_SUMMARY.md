# ğŸ”§ Service Worker é›¢ç·šç·©å­˜å¯¦ç¾ç¸½çµ

## ğŸ“‹ å¯¦ç¾æ¦‚è¿°

æœ¬é …ç›®å·²æˆåŠŸå¯¦ç¾äº†å®Œæ•´çš„ Service Worker é›¢ç·šç·©å­˜åŠŸèƒ½ï¼Œç‚º CardStrategy æ‡‰ç”¨æä¾›äº†å¼·å¤§çš„é›¢ç·šæ”¯æŒå’Œæ€§èƒ½å„ªåŒ–ã€‚

## âœ… å·²å¯¦ç¾çš„åŠŸèƒ½

### 1. **æ ¸å¿ƒ Service Worker** (`public/sw.js`)

#### ä¸»è¦åŠŸèƒ½
- **é›¢ç·šç·©å­˜ç­–ç•¥**: å¯¦ç¾äº†å¤šç¨®ç·©å­˜ç­–ç•¥ï¼ˆCache Firstã€Network Firstï¼‰
- **è³‡æºé åŠ è¼‰**: è‡ªå‹•é åŠ è¼‰æ ¸å¿ƒè³‡æºå’Œ API æ•¸æ“š
- **æ™ºèƒ½ç·©å­˜ç®¡ç†**: è‡ªå‹•æ¸…ç†éæœŸç·©å­˜ï¼Œå„ªåŒ–å­˜å„²ç©ºé–“
- **èƒŒæ™¯åŒæ­¥**: æ”¯æ´é›¢ç·šæ“ä½œå’Œç¶²çµ¡æ¢å¾©å¾Œçš„æ•¸æ“šåŒæ­¥
- **æ¨é€é€šçŸ¥**: å®Œæ•´çš„æ¨é€é€šçŸ¥ç³»çµ±
- **éŒ¯èª¤è™•ç†**: å®Œå–„çš„éŒ¯èª¤è™•ç†å’Œé™ç´šç­–ç•¥

#### ç·©å­˜ç­–ç•¥
```javascript
// éœæ…‹è³‡æº - Cache First ç­–ç•¥
if (isStaticAsset(url)) {
  return await cacheFirst(request, STATIC_CACHE);
}

// API è«‹æ±‚ - Network First ç­–ç•¥
if (isApiRequest(url)) {
  return await networkFirst(request, API_CACHE);
}

// åœ–ç‰‡è³‡æº - Cache First ç­–ç•¥
if (isImageRequest(url)) {
  return await cacheFirst(request, IMAGE_CACHE);
}
```

### 2. **Service Worker ç®¡ç†å™¨** (`src/utils/serviceWorkerManager.ts`)

#### æ ¸å¿ƒåŠŸèƒ½
- **è¨»å†Šç®¡ç†**: è‡ªå‹•è¨»å†Šå’Œæ›´æ–° Service Worker
- **ç‹€æ…‹ç›£æ§**: å¯¦æ™‚ç›£æ§ Service Worker ç‹€æ…‹
- **ç·©å­˜ç®¡ç†**: æä¾›ç·©å­˜ä¿¡æ¯çš„æŸ¥è©¢å’Œç®¡ç†
- **åŒæ­¥éšŠåˆ—**: ç®¡ç†é›¢ç·šæ“ä½œçš„åŒæ­¥éšŠåˆ—
- **é€šçŸ¥ç®¡ç†**: è™•ç†æ¨é€é€šçŸ¥çš„æ¬Šé™å’Œç™¼é€
- **æ€§èƒ½ç›£æ§**: ç›£æ§ç·©å­˜ä½¿ç”¨æƒ…æ³å’Œæ€§èƒ½æŒ‡æ¨™

#### ä¸»è¦æ–¹æ³•
```typescript
// åˆå§‹åŒ–
await swManager.init();

// ç™¼é€é€šçŸ¥
await swManager.sendNotification('æ¨™é¡Œ', { body: 'å…§å®¹' });

// è¨»å†ŠèƒŒæ™¯åŒæ­¥
await swManager.registerBackgroundSync('sync-tag', data);

// ç²å–ç·©å­˜ä¿¡æ¯
const cacheInfo = await swManager.getCacheInfo();

// æ¸…ç†ç·©å­˜
await swManager.clearCache();
```

### 3. **React Hook** (`src/hooks/useServiceWorker.ts`)

#### åŠŸèƒ½ç‰¹æ€§
- **ç‹€æ…‹ç®¡ç†**: æä¾› Service Worker çš„å®Œæ•´ç‹€æ…‹
- **è‡ªå‹•æ›´æ–°**: è‡ªå‹•æª¢æ¸¬å’Œè™•ç†æ›´æ–°
- **éŒ¯èª¤è™•ç†**: çµ±ä¸€çš„éŒ¯èª¤è™•ç†æ©Ÿåˆ¶
- **æ€§èƒ½å„ªåŒ–**: å®šæœŸåˆ·æ–°ç·©å­˜ä¿¡æ¯

#### ä½¿ç”¨ç¤ºä¾‹
```typescript
const {
  status,
  cacheInfo,
  syncQueue,
  sendNotification,
  registerBackgroundSync,
  clearCache,
} = useServiceWorker();
```

### 4. **UI çµ„ä»¶** (`src/components/common/ServiceWorkerStatus.tsx`)

#### åŠŸèƒ½ç‰¹æ€§
- **ç‹€æ…‹é¡¯ç¤º**: å¯¦æ™‚é¡¯ç¤ºç¶²çµ¡å’Œ Service Worker ç‹€æ…‹
- **ç·©å­˜ç®¡ç†**: é¡¯ç¤ºç·©å­˜ä¿¡æ¯å’Œç®¡ç†åŠŸèƒ½
- **åŒæ­¥éšŠåˆ—**: é¡¯ç¤ºå¾…åŒæ­¥çš„æ•¸æ“š
- **æ“ä½œæ§åˆ¶**: æä¾›æ›´æ–°ã€æ¸…ç†ç­‰æ“ä½œæŒ‰éˆ•

### 5. **é›¢ç·šé é¢** (`public/offline.html`)

#### åŠŸèƒ½ç‰¹æ€§
- **ç”¨æˆ¶å‹å¥½**: ç¾è§€çš„é›¢ç·šé é¢è¨­è¨ˆ
- **åŠŸèƒ½èªªæ˜**: æ¸…æ¥šèªªæ˜é›¢ç·šæ™‚å¯ç”¨çš„åŠŸèƒ½
- **ç¶²çµ¡æª¢æ¸¬**: è‡ªå‹•æª¢æ¸¬ç¶²çµ¡ç‹€æ…‹
- **é‡é€£åŠŸèƒ½**: æä¾›é‡æ–°é€£æ¥å’Œç¹¼çºŒé›¢ç·šä½¿ç”¨çš„é¸é …

### 6. **PWA é…ç½®** (`public/manifest.json`)

#### é…ç½®ç‰¹æ€§
- **å®Œæ•´ PWA**: æ”¯æ´å®‰è£åˆ°ä¸»å±å¹•
- **å¿«æ·æ–¹å¼**: æä¾›å¸¸ç”¨åŠŸèƒ½çš„å¿«æ·æ–¹å¼
- **æ–‡ä»¶è™•ç†**: æ”¯æ´åœ–ç‰‡æ–‡ä»¶çš„ä¸Šå‚³
- **åˆ†äº«åŠŸèƒ½**: æ”¯æ´å…§å®¹åˆ†äº«
- **å”è­°è™•ç†**: æ”¯æ´è‡ªå®šç¾©å”è­°

## ğŸ”§ æŠ€è¡“å¯¦ç¾ç´°ç¯€

### ç·©å­˜ç­–ç•¥

#### 1. Cache First ç­–ç•¥
- **é©ç”¨å ´æ™¯**: éœæ…‹è³‡æºã€åœ–ç‰‡
- **å„ªé»**: å¿«é€ŸéŸ¿æ‡‰ï¼Œæ¸›å°‘ç¶²çµ¡è«‹æ±‚
- **å¯¦ç¾**: å„ªå…ˆå¾ç·©å­˜è¿”å›ï¼Œå¤±æ•—æ™‚å¾ç¶²çµ¡ç²å–

#### 2. Network First ç­–ç•¥
- **é©ç”¨å ´æ™¯**: API è«‹æ±‚ã€å‹•æ…‹å…§å®¹
- **å„ªé»**: ä¿è­‰æ•¸æ“šæ–°é®®åº¦
- **å¯¦ç¾**: å„ªå…ˆå¾ç¶²çµ¡ç²å–ï¼Œå¤±æ•—æ™‚å¾ç·©å­˜è¿”å›

### èƒŒæ™¯åŒæ­¥

#### å¯¦ç¾æ©Ÿåˆ¶
```javascript
// è¨»å†ŠèƒŒæ™¯åŒæ­¥
self.addEventListener('sync', (event) => {
  if (event.tag === 'background-sync') {
    event.waitUntil(doBackgroundSync());
  }
});

// åŸ·è¡ŒåŒæ­¥
async function doBackgroundSync() {
  const pendingData = await getPendingSyncData();
  for (const data of pendingData) {
    await syncData(data);
  }
}
```

### æ¨é€é€šçŸ¥

#### å¯¦ç¾ç‰¹æ€§
- **æ¬Šé™ç®¡ç†**: è‡ªå‹•è«‹æ±‚é€šçŸ¥æ¬Šé™
- **é€šçŸ¥é¡¯ç¤º**: æ”¯æ´è±å¯Œçš„é€šçŸ¥å…§å®¹
- **é»æ“Šè™•ç†**: è™•ç†é€šçŸ¥é»æ“Šäº‹ä»¶
- **å‹•ä½œæŒ‰éˆ•**: æ”¯æ´é€šçŸ¥å‹•ä½œæŒ‰éˆ•

## ğŸ“Š æ€§èƒ½å„ªåŒ–

### ç·©å­˜å„ªåŒ–
- **åˆ†å±¤ç·©å­˜**: éœæ…‹è³‡æºã€APIã€åœ–ç‰‡åˆ†åˆ¥ç·©å­˜
- **æ™ºèƒ½æ¸…ç†**: è‡ªå‹•æ¸…ç†éæœŸç·©å­˜
- **å¤§å°é™åˆ¶**: æ§åˆ¶ç·©å­˜ç¸½å¤§å°
- **ç‰ˆæœ¬ç®¡ç†**: æ”¯æ´ç·©å­˜ç‰ˆæœ¬æ›´æ–°

### ç¶²çµ¡å„ªåŒ–
- **è«‹æ±‚å»é‡**: é¿å…é‡è¤‡è«‹æ±‚
- **æ‰¹é‡è™•ç†**: æ”¯æ´æ‰¹é‡è«‹æ±‚è™•ç†
- **é‡è©¦æ©Ÿåˆ¶**: è‡ªå‹•é‡è©¦å¤±æ•—çš„è«‹æ±‚
- **è¶…æ™‚æ§åˆ¶**: è¨­ç½®åˆç†çš„è¶…æ™‚æ™‚é–“

## ğŸš€ ä½¿ç”¨æŒ‡å—

### 1. åŸºæœ¬ä½¿ç”¨

#### åœ¨çµ„ä»¶ä¸­ä½¿ç”¨
```tsx
import { useServiceWorker } from '@/hooks/useServiceWorker';

const MyComponent = () => {
  const { status, sendNotification } = useServiceWorker();
  
  const handleNotification = () => {
    sendNotification('æ–°æ¶ˆæ¯', { body: 'æ‚¨æœ‰æ–°çš„é€šçŸ¥' });
  };
  
  return (
    <div>
      <p>ç¶²çµ¡ç‹€æ…‹: {status.online ? 'åœ¨ç·š' : 'é›¢ç·š'}</p>
      <button onClick={handleNotification}>ç™¼é€é€šçŸ¥</button>
    </div>
  );
};
```

#### é¡¯ç¤ºç‹€æ…‹çµ„ä»¶
```tsx
import { ServiceWorkerStatus } from '@/components/common/ServiceWorkerStatus';

<ServiceWorkerStatus showDetails={true} />
```

### 2. é›¢ç·šæ“ä½œ

#### æ·»åŠ åŒæ­¥æ•¸æ“š
```typescript
import { swManager } from '@/utils/serviceWorkerManager';

const syncData = {
  id: 'unique-id',
  url: '/api/cards',
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(cardData),
  timestamp: Date.now(),
  retryCount: 0,
};

swManager.addToSyncQueue(syncData);
```

#### è¨»å†ŠèƒŒæ™¯åŒæ­¥
```typescript
await swManager.registerBackgroundSync('card-sync', {
  action: 'create-card',
  data: cardData,
});
```

### 3. ç·©å­˜ç®¡ç†

#### é åŠ è¼‰è³‡æº
```typescript
const resources = [
  '/api/cards',
  '/api/collections',
  '/images/logo.png',
];

await swManager.preloadResources(resources);
```

#### æ¸…ç†ç·©å­˜
```typescript
// æ¸…ç†æ‰€æœ‰ç·©å­˜
await swManager.clearCache();

// æ¸…ç†ç‰¹å®šç·©å­˜
await swManager.clearCache('api-cache');
```

## ğŸ” èª¿è©¦å’Œç›£æ§

### é–‹ç™¼å·¥å…·
- **Chrome DevTools**: ä½¿ç”¨ Application æ¨™ç±¤æŸ¥çœ‹ Service Worker
- **ç·©å­˜æª¢æŸ¥**: æŸ¥çœ‹ Cache Storage ä¸­çš„ç·©å­˜å…§å®¹
- **ç¶²çµ¡ç›£æ§**: ä½¿ç”¨ Network æ¨™ç±¤ç›£æ§è«‹æ±‚

### æ—¥èªŒç›£æ§
```javascript
// Service Worker æ—¥èªŒ
console.log('[SW] Service Worker å·²è¼‰å…¥');
console.log('[SW] ç·©å­˜æ–°è³‡æº:', request.url);
console.log('[SW] å¾ç·©å­˜è¿”å›:', request.url);
```

### æ€§èƒ½ç›£æ§
```typescript
// ç²å–ç·©å­˜ä¿¡æ¯
const cacheInfo = await swManager.getCacheInfo();
console.log('ç·©å­˜ä½¿ç”¨æƒ…æ³:', cacheInfo);

// ç²å–åŒæ­¥éšŠåˆ—
const syncQueue = swManager.getSyncQueue();
console.log('å¾…åŒæ­¥æ•¸æ“š:', syncQueue);
```

## ğŸ¯ æœ€ä½³å¯¦è¸

### 1. ç·©å­˜ç­–ç•¥é¸æ“‡
- **éœæ…‹è³‡æº**: ä½¿ç”¨ Cache First
- **API æ•¸æ“š**: ä½¿ç”¨ Network First
- **åœ–ç‰‡è³‡æº**: ä½¿ç”¨ Cache First
- **ç”¨æˆ¶æ•¸æ“š**: ä½¿ç”¨ Network First

### 2. éŒ¯èª¤è™•ç†
- **é™ç´šç­–ç•¥**: æä¾›é›¢ç·šåŠŸèƒ½
- **é‡è©¦æ©Ÿåˆ¶**: è‡ªå‹•é‡è©¦å¤±æ•—è«‹æ±‚
- **ç”¨æˆ¶æç¤º**: æ¸…æ¥šå‘ŠçŸ¥ç”¨æˆ¶ç•¶å‰ç‹€æ…‹

### 3. æ€§èƒ½å„ªåŒ–
- **è³‡æºé åŠ è¼‰**: é åŠ è¼‰é—œéµè³‡æº
- **ç·©å­˜æ¸…ç†**: å®šæœŸæ¸…ç†éæœŸç·©å­˜
- **å¤§å°æ§åˆ¶**: æ§åˆ¶ç·©å­˜ç¸½å¤§å°

## ğŸ“ˆ é æœŸæ•ˆæœ

### æ€§èƒ½æå‡
- **é¦–æ¬¡è¼‰å…¥**: æå‡ 40-60%
- **é›¢ç·šé«”é©—**: 100% å¯ç”¨
- **ç¶²çµ¡è«‹æ±‚**: æ¸›å°‘ 50-70%
- **ç”¨æˆ¶é«”é©—**: é¡¯è‘—æ”¹å–„

### åŠŸèƒ½å¢å¼·
- **é›¢ç·šæ“ä½œ**: æ”¯æ´å®Œæ•´çš„é›¢ç·šåŠŸèƒ½
- **èƒŒæ™¯åŒæ­¥**: è‡ªå‹•åŒæ­¥é›¢ç·šæ•¸æ“š
- **æ¨é€é€šçŸ¥**: å³æ™‚é€šçŸ¥ç”¨æˆ¶
- **PWA æ”¯æ´**: å¯å®‰è£åˆ°ä¸»å±å¹•

## ğŸ”® æœªä¾†è¨ˆåŠƒ

### çŸ­æœŸè¨ˆåŠƒ
- [ ] æ·»åŠ æ›´å¤šç·©å­˜ç­–ç•¥
- [ ] å„ªåŒ–èƒŒæ™¯åŒæ­¥æ©Ÿåˆ¶
- [ ] å¢å¼·æ¨é€é€šçŸ¥åŠŸèƒ½

### ä¸­æœŸè¨ˆåŠƒ
- [ ] å¯¦ç¾è™›æ“¬æ»¾å‹•å„ªåŒ–
- [ ] æ·»åŠ æ›´å¤š PWA åŠŸèƒ½
- [ ] å¯¦ç¾å¯¦æ™‚æ•¸æ“šåŒæ­¥

### é•·æœŸè¨ˆåŠƒ
- [ ] æ©Ÿå™¨å­¸ç¿’å„ªåŒ–ç·©å­˜
- [ ] å¯¦ç¾è·¨è¨­å‚™åŒæ­¥
- [ ] æ·»åŠ æ›´å¤šé›¢ç·šåŠŸèƒ½

## ğŸ‰ ç¸½çµ

é€šéå¯¦ç¾å®Œæ•´çš„ Service Worker é›¢ç·šç·©å­˜åŠŸèƒ½ï¼ŒCardStrategy æ‡‰ç”¨ç¾åœ¨å…·å‚™äº†ï¼š

1. **å¼·å¤§çš„é›¢ç·šæ”¯æ´**: ç”¨æˆ¶å¯ä»¥åœ¨é›¢ç·šç‹€æ…‹ä¸‹æ­£å¸¸ä½¿ç”¨æ‡‰ç”¨
2. **å„ªç§€çš„æ€§èƒ½**: å¤§å¹…æå‡è¼‰å…¥é€Ÿåº¦å’ŒéŸ¿æ‡‰æ™‚é–“
3. **è‰¯å¥½çš„ç”¨æˆ¶é«”é©—**: æµæš¢çš„æ“ä½œå’Œå³æ™‚çš„é€šçŸ¥
4. **å®Œæ•´çš„ PWA åŠŸèƒ½**: æ”¯æ´å®‰è£å’Œé›¢ç·šä½¿ç”¨

é€™äº›åŠŸèƒ½ç‚ºæ‡‰ç”¨çš„é•·æœŸç™¼å±•å¥ å®šäº†å …å¯¦çš„åŸºç¤ï¼Œä¸¦ç‚ºç”¨æˆ¶æä¾›äº†æ›´å¥½çš„ä½¿ç”¨é«”é©—ã€‚
