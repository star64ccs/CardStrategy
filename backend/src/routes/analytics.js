const express = require('express');
const router = express.Router();
const analyticsService = require('../services/advancedAnalytics');
const { authenticateToken } = require('../middleware/auth');
const { validateRequest } = require('../middleware/validation');
// eslint-disable-next-line no-unused-vars
const logger = require('../utils/logger');

// ?≤Â?Â∏ÇÂ†¥Ë∂®Âã¢?ÜÊ?
router.get('/market/trends', authenticateToken, async (req, res) => {
  try {
    const { timeframe, categories, limit, useCache } = req.query;

    const trends = await analyticsService.getMarketTrends({
      timeframe: timeframe || '30d',
      categories: categories ? categories.split(',') : [],
      limit: parseInt(limit) || 50,
      useCache: useCache !== 'false',
    });

    res.json({
      success: true,
      data: trends,
    });
  } catch (error) {
    logger.error('?≤Â?Â∏ÇÂ†¥Ë∂®Âã¢?ÜÊ?Â§±Ê?:', error);
    res.status(500).json({
      success: false,
      error: 'Â∏ÇÂ†¥Ë∂®Âã¢?ÜÊ?Â§±Ê?',
    });
  }
});

// ?≤Â??ïË?ÁµÑÂ??ÜÊ?
router.get('/portfolio/:userId', authenticateToken, async (req, res) => {
  try {
    const { userId } = req.params;
    const { timeframe, includeTransactions, includePerformance, useCache } =
      req.query;

    const analysis = await analyticsService.getPortfolioAnalysis(userId, {
      timeframe: timeframe || '30d',
      includeTransactions: includeTransactions !== 'false',
      includePerformance: includePerformance !== 'false',
      useCache: useCache !== 'false',
    });

    res.json({
      success: true,
      data: analysis,
    });
  } catch (error) {
    logger.error('?≤Â??ïË?ÁµÑÂ??ÜÊ?Â§±Ê?:', error);
    res.status(500).json({
      success: false,
      error: '?ïË?ÁµÑÂ??ÜÊ?Â§±Ê?',
    });
  }
});

// ?≤Â??®Êà∂Ë°åÁÇ∫?ÜÊ?
router.get('/user/:userId/behavior', authenticateToken, async (req, res) => {
  try {
    const { userId } = req.params;
    const { timeframe, includePatterns, includePredictions, useCache } =
      req.query;

    const behavior = await analyticsService.getUserBehaviorAnalysis(userId, {
      timeframe: timeframe || '30d',
      includePatterns: includePatterns !== 'false',
      includePredictions: includePredictions !== 'false',
      useCache: useCache !== 'false',
    });

    res.json({
      success: true,
      data: behavior,
    });
  } catch (error) {
    logger.error('?≤Â??®Êà∂Ë°åÁÇ∫?ÜÊ?Â§±Ê?:', error);
    res.status(500).json({
      success: false,
      error: '?®Êà∂Ë°åÁÇ∫?ÜÊ?Â§±Ê?',
    });
  }
});

// ?üÊ?Á∂úÂ??±Â?
router.post('/reports/comprehensive', authenticateToken, async (req, res) => {
  try {
    const {
      reportType,
      startDate,
      endDate,
      includeCharts,
      includeRecommendations,
      format,
    } = req.body;

    const report = await analyticsService.generateComprehensiveReport({
      reportType: reportType || 'monthly',
      startDate: startDate ? new Date(startDate) : undefined,
      endDate: endDate ? new Date(endDate) : undefined,
      includeCharts: includeCharts !== false,
      includeRecommendations: includeRecommendations !== false,
      format: format || 'json',
    });

    res.json({
      success: true,
      data: report,
    });
  } catch (error) {
    logger.error('?üÊ?Á∂úÂ??±Â?Â§±Ê?:', error);
    res.status(500).json({
      success: false,
      error: '?±Â??üÊ?Â§±Ê?',
    });
  }
});

// ?≤Â??êÊ∏¨?ÜÊ?
router.get('/predictive', authenticateToken, async (req, res) => {
  try {
    const { target, timeframe, confidence, useCache } = req.query;

// eslint-disable-next-line no-unused-vars
    const predictions = await analyticsService.getPredictiveAnalysis({
      target: target || 'price',
      timeframe: timeframe || '7d',
      confidence: parseFloat(confidence) || 0.8,
      useCache: useCache !== 'false',
    });

    res.json({
      success: true,
      data: predictions,
    });
  } catch (error) {
    logger.error('?≤Â??êÊ∏¨?ÜÊ?Â§±Ê?:', error);
    res.status(500).json({
      success: false,
      error: '?êÊ∏¨?ÜÊ?Â§±Ê?',
    });
  }
});

// ?≤Â??∞Â∏∏Ê™¢Ê∏¨
router.get('/anomaly', authenticateToken, async (req, res) => {
  try {
    const { type, sensitivity, timeframe, useCache } = req.query;

    const anomalies = await analyticsService.getAnomalyDetection({
      type: type || 'price',
      sensitivity: sensitivity || 'medium',
      timeframe: timeframe || '24h',
      useCache: useCache !== 'false',
    });

    res.json({
      success: true,
      data: anomalies,
    });
  } catch (error) {
    logger.error('?≤Â??∞Â∏∏Ê™¢Ê∏¨Â§±Ê?:', error);
    res.status(500).json({
      success: false,
      error: '?∞Â∏∏Ê™¢Ê∏¨Â§±Ê?',
    });
  }
});

// ?≤Â??∏È??ßÂ???router.get('/correlation', authenticateToken, async (req, res) => {
  try {
    const { variables, timeframe, method, useCache } = req.query;

    const correlations = await analyticsService.getCorrelationAnalysis({
      variables: variables
        ? variables.split(',')
        : ['price', 'volume', 'demand'],
      timeframe: timeframe || '30d',
      method: method || 'pearson',
      useCache: useCache !== 'false',
    });

    res.json({
      success: true,
      data: correlations,
    });
  } catch (error) {
    logger.error('?≤Â??∏È??ßÂ??êÂ§±??', error);
    res.status(500).json({
      success: false,
      error: '?∏È??ßÂ??êÂ§±??,
    });
  }
});

// ?≤Â??ÜÊÆµ?ÜÊ?
router.get('/segmentation', authenticateToken, async (req, res) => {
  try {
    const { dimension, criteria, segments, useCache } = req.query;

    const segmentation = await analyticsService.getSegmentationAnalysis({
      dimension: dimension || 'user',
      criteria: criteria
        ? criteria.split(',')
        : ['activity', 'value', 'preference'],
      segments: parseInt(segments) || 5,
      useCache: useCache !== 'false',
    });

    res.json({
      success: true,
      data: segmentation,
    });
  } catch (error) {
    logger.error('?≤Â??ÜÊÆµ?ÜÊ?Â§±Ê?:', error);
    res.status(500).json({
      success: false,
      error: '?ÜÊÆµ?ÜÊ?Â§±Ê?',
    });
  }
});

// ?≤Â??ÜÊ??áÊ?
router.get('/metrics', authenticateToken, async (req, res) => {
  try {
    const { timeframe, includeTrends, useCache } = req.query;

    const metrics = await analyticsService.getAnalyticsMetrics({
      timeframe: timeframe || '24h',
      includeTrends: includeTrends !== 'false',
      useCache: useCache !== 'false',
    });

    res.json({
      success: true,
      data: metrics,
    });
  } catch (error) {
    logger.error('?≤Â??ÜÊ??áÊ?Â§±Ê?:', error);
    res.status(500).json({
      success: false,
      error: '?ÜÊ??áÊ??≤Â?Â§±Ê?',
    });
  }
});

// Ê∏ÖÁ??ÜÊ?Á∑©Â?
router.delete('/cache', authenticateToken, async (req, res) => {
  try {
    const { pattern } = req.query;

// eslint-disable-next-line no-unused-vars
    const result = await analyticsService.clearAnalyticsCache(pattern || '*');

    res.json({
      success: true,
      data: result,
    });
  } catch (error) {
    logger.error('Ê∏ÖÁ??ÜÊ?Á∑©Â?Â§±Ê?:', error);
    res.status(500).json({
      success: false,
      error: 'Á∑©Â?Ê∏ÖÁ?Â§±Ê?',
    });
  }
});

// ?•Â∫∑Ê™¢Êü•
router.get('/health', async (req, res) => {
  try {
    const health = await analyticsService.healthCheck();

    res.json({
      success: true,
      data: health,
    });
  } catch (error) {
    logger.error('?ÜÊ??çÂ??•Â∫∑Ê™¢Êü•Â§±Ê?:', error);
    res.status(500).json({
      success: false,
      error: '?•Â∫∑Ê™¢Êü•Â§±Ê?',
    });
  }
});

// ?≤Â??±Â?Ê®°Êùø
router.get('/reports/templates', authenticateToken, async (req, res) => {
  try {
    const templates = [
      {
        id: 'market_summary',
        name: 'Â∏ÇÂ†¥?òË??±Â?',
        description: 'Â∏ÇÂ†¥Ë∂®Âã¢?åÈ??µÊ?Ê®ôÊ?Ë¶?,
        type: 'summary',
        parameters: ['timeframe', 'categories'],
      },
      {
        id: 'portfolio_analysis',
        name: '?ïË?ÁµÑÂ??ÜÊ??±Â?',
        description: 'Ë©≥Á¥∞?ÑÊ?Ë≥áÁ??àË°®?æÂ???,
        type: 'detailed',
        parameters: ['userId', 'timeframe', 'includeCharts'],
      },
      {
        id: 'user_behavior',
        name: '?®Êà∂Ë°åÁÇ∫?±Â?',
        description: '?®Êà∂Ë°åÁÇ∫Ê®°Â??åË∂®?¢Â???,
        type: 'behavioral',
        parameters: ['userId', 'timeframe', 'includePredictions'],
      },
      {
        id: 'financial_performance',
        name: 'Ë≤°Â?Ë°®Áèæ?±Â?',
        description: 'Ë≤°Â??áÊ??åÊî∂?äÂ???,
        type: 'financial',
        parameters: ['timeframe', 'includeProjections'],
      },
      {
        id: 'technical_analysis',
        name: '?ÄË°ìÂ??êÂ†±??,
        description: '?ÄË°ìÊ?Ê®ôÂ??ñË°®?ÜÊ?',
        type: 'technical',
        parameters: ['symbol', 'timeframe', 'indicators'],
      },
    ];

    res.json({
      success: true,
      data: templates,
    });
  } catch (error) {
    logger.error('?≤Â??±Â?Ê®°ÊùøÂ§±Ê?:', error);
    res.status(500).json({
      success: false,
      error: '?±Â?Ê®°Êùø?≤Â?Â§±Ê?',
    });
  }
});

// ?üÊ??™Â?Áæ©Â†±??router.post('/reports/custom', authenticateToken, async (req, res) => {
  try {
    const { templateId, parameters, format } = req.body;

    // ?πÊ?Ê®°ÊùøID?üÊ??∏Ê??ÑÂ†±??    let report;
    switch (templateId) {
      case 'market_summary':
        report = await analyticsService.getMarketTrends(parameters);
        break;
      case 'portfolio_analysis':
        report = await analyticsService.getPortfolioAnalysis(
          parameters.userId,
          parameters
        );
        break;
      case 'user_behavior':
        report = await analyticsService.getUserBehaviorAnalysis(
          parameters.userId,
          parameters
        );
        break;
      case 'financial_performance':
        report = await analyticsService.generateComprehensiveReport({
          reportType: 'custom',
          ...parameters,
        });
        break;
      case 'technical_analysis':
        report = await analyticsService.getPredictiveAnalysis(parameters);
        break;
      default:
        throw new Error('?™Áü•?ÑÂ†±?äÊ®°??);
    }

    res.json({
      success: true,
      data: report,
    });
  } catch (error) {
    logger.error('?üÊ??™Â?Áæ©Â†±?äÂ§±??', error);
    res.status(500).json({
      success: false,
      error: '?™Â?Áæ©Â†±?äÁ??êÂ§±??,
    });
  }
});

// ?≤Â??ÜÊ??çÁΩÆ
router.get('/config', authenticateToken, async (req, res) => {
  try {
// eslint-disable-next-line no-unused-vars
    const config = {
      cacheTTL: 3600,
      maxDataPoints: 1000,
      defaultTimeframe: '30d',
      batchSize: 100,
      supportedTimeframes: ['1d', '7d', '30d', '90d', '1y'],
      supportedAnalysisTypes: [
        'trend',
        'correlation',
        'prediction',
        'segmentation',
        'anomaly',
      ],
      supportedReportTypes: [
        'daily',
        'weekly',
        'monthly',
        'quarterly',
        'yearly',
        'custom',
      ],
    };

    res.json({
      success: true,
      data: config,
    });
  } catch (error) {
    logger.error('?≤Â??ÜÊ??çÁΩÆÂ§±Ê?:', error);
    res.status(500).json({
      success: false,
      error: '?çÁΩÆ?≤Â?Â§±Ê?',
    });
  }
});

// ?¥Êñ∞?ÜÊ??çÁΩÆ
router.put('/config', authenticateToken, async (req, res) => {
  try {
    const { cacheTTL, maxDataPoints, defaultTimeframe, batchSize } = req.body;

    // ?ôË£°?Ø‰ª•ÂØ¶Áèæ?çÁΩÆ?¥Êñ∞?èËºØ
    const updatedConfig = {
      cacheTTL: cacheTTL || 3600,
      maxDataPoints: maxDataPoints || 1000,
      defaultTimeframe: defaultTimeframe || '30d',
      batchSize: batchSize || 100,
    };

    res.json({
      success: true,
      data: updatedConfig,
      message: '?çÁΩÆ?¥Êñ∞?êÂ?',
    });
  } catch (error) {
    logger.error('?¥Êñ∞?ÜÊ??çÁΩÆÂ§±Ê?:', error);
    res.status(500).json({
      success: false,
      error: '?çÁΩÆ?¥Êñ∞Â§±Ê?',
    });
  }
});

// ?≤Â??ÜÊ?Ê≠∑Âè≤
router.get('/history', authenticateToken, async (req, res) => {
  try {
    const { userId, type, limit, offset } = req.query;

    // ?ôË£°?Ø‰ª•ÂØ¶Áèæ?ÜÊ?Ê≠∑Âè≤?•Ë©¢?èËºØ
// eslint-disable-next-line no-unused-vars
    const history = [
      {
        id: 1,
        type: 'market_trends',
        userId,
        parameters: { timeframe: '30d' },
        status: 'completed',
        createdAt: new Date(),
        completedAt: new Date(),
      },
    ];

    res.json({
      success: true,
      data: history,
    });
  } catch (error) {
    logger.error('?≤Â??ÜÊ?Ê≠∑Âè≤Â§±Ê?:', error);
    res.status(500).json({
      success: false,
      error: 'Ê≠∑Âè≤Ë®òÈ??≤Â?Â§±Ê?',
    });
  }
});

// Â∞éÂá∫?ÜÊ??∏Ê?
router.post('/export', authenticateToken, async (req, res) => {
  try {
    const { type, parameters, format } = req.body;

    // ?ôË£°?Ø‰ª•ÂØ¶Áèæ?∏Ê?Â∞éÂá∫?èËºØ
    const exportData = {
      type,
      parameters,
      format: format || 'csv',
      downloadUrl: `/api/analytics/downloads/${Date.now()}.${format || 'csv'}`,
      expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000), // 24Â∞èÊ?ÂæåÈ???    };

    res.json({
      success: true,
      data: exportData,
    });
  } catch (error) {
    logger.error('Â∞éÂá∫?ÜÊ??∏Ê?Â§±Ê?:', error);
    res.status(500).json({
      success: false,
      error: '?∏Ê?Â∞éÂá∫Â§±Ê?',
    });
  }
});

// ?≤Â??ÜÊ?Áµ±Ë?
router.get('/stats', authenticateToken, async (req, res) => {
  try {
    const { timeframe } = req.query;

    const stats = {
      totalAnalyses: 1250,
      totalReports: 340,
      avgProcessingTime: 2.5,
      cacheHitRate: 0.85,
      errorRate: 0.02,
      topAnalysisTypes: [
        { type: 'market_trends', count: 450 },
        { type: 'portfolio_analysis', count: 320 },
        { type: 'user_behavior', count: 280 },
      ],
      timeframe: timeframe || '30d',
    };

    res.json({
      success: true,
      data: stats,
    });
  } catch (error) {
    logger.error('?≤Â??ÜÊ?Áµ±Ë?Â§±Ê?:', error);
    res.status(500).json({
      success: false,
      error: 'Áµ±Ë??∏Ê??≤Â?Â§±Ê?',
    });
  }
});

module.exports = router;
